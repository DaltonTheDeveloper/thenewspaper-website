<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Newsroom ¬∑ Daily Political Briefing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #050512;
      --bg-panel: rgba(19, 20, 48, 0.88);
      --bg-panel-soft: rgba(25, 26, 64, 0.9);
      --border-subtle: rgba(255, 255, 255, 0.08);
      --text-main: #f5f5ff;
      --text-muted: #a3a3c4;
      --accent-1: #b483ff;
      --accent-2: #5fd4ff;
      --accent-3: #ffc36b;
      --danger: #ff6b81;
      --radius-lg: 24px;
      --radius-pill: 999px;
      --shadow-soft: 0 20px 60px rgba(0, 0, 0, 0.9);
      --transition-fast: 0.18s ease-out;
      --transition-med: 0.25s ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Inter", sans-serif;
      color: var(--text-main);
      background:
        radial-gradient(circle at top left, #271744 0, #050512 45%),
        radial-gradient(circle at bottom right, #02061c 0, #050512 55%);
      padding: 24px 16px 40px;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 980px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Header */

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 18px;
      margin-bottom: 4px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 20px;
      background:
        radial-gradient(circle at 30% 20%, #ffffff, #e0d7ff 35%, #b483ff 65%, #5fd4ff 100%);
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.6),
        0 10px 30px rgba(0, 0, 0, 0.85);
    }

    .brand-labels {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-text-title {
      font-weight: 600;
      font-size: 19px;
      letter-spacing: 0.02em;
    }

    .brand-text-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .right-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 5px 12px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: linear-gradient(
        135deg,
        rgba(180, 131, 255, 0.16),
        rgba(95, 212, 255, 0.16)
      );
      font-size: 11px;
      white-space: nowrap;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #5fd4ff, #b483ff);
      box-shadow: 0 0 10px rgba(160, 255, 255, 0.9);
    }

    .pill-label {
      color: var(--text-main);
    }

    .btn-login {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.24);
      background: rgba(10, 12, 40, 0.98);
      color: var(--text-main);
      padding: 7px 14px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        border-color var(--transition-fast),
        background var(--transition-fast),
        color var(--transition-fast);
    }

    .btn-login:hover {
      transform: translateY(-1px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.9);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .btn-login .icon {
      font-size: 14px;
    }

    /* Layout */

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.3fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media (max-width: 880px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .right-header {
        align-self: stretch;
        justify-content: space-between;
      }
    }

    /* Main card */

    .card-main {
      position: relative;
      border-radius: 28px;
      padding: 20px 18px 18px;
      background:
        radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.1), transparent 52%),
        radial-gradient(circle at 100% 120%, rgba(95, 212, 255, 0.15), transparent 55%),
        linear-gradient(145deg, rgba(10, 11, 36, 0.98), rgba(2, 5, 21, 0.98));
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .card-main::before {
      content: "";
      position: absolute;
      inset: -40px;
      background: radial-gradient(
        circle at 0 0,
        rgba(255, 255, 255, 0.12),
        transparent 55%
      );
      mix-blend-mode: soft-light;
      opacity: 0.7;
      pointer-events: none;
    }

    .card-main > * {
      position: relative;
      z-index: 1;
    }

    .main-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .headline {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .headline-kicker {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(218, 219, 255, 0.8);
    }

    .headline-main {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .headline-sub {
      font-size: 13px;
      color: var(--text-muted);
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(11, 13, 38, 0.96);
      font-size: 11px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #5fd4ff, #b483ff);
      box-shadow: 0 0 10px rgba(160, 255, 255, 0.9);
    }

    .status-chip strong {
      color: #ffffff;
    }

    .main-body {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.2fr);
      gap: 14px;
      align-items: flex-start;
    }

    @media (max-width: 720px) {
      .main-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .tldr {
      background: linear-gradient(
        150deg,
        rgba(11, 15, 54, 0.92),
        rgba(5, 9, 32, 0.98)
      );
      border-radius: 18px;
      padding: 12px 13px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .tldr-label {
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(218, 219, 255, 0.9);
      margin-bottom: 6px;
    }

    .tldr-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .tldr-list li {
      display: flex;
      gap: 7px;
      line-height: 1.4;
    }

    .tldr-bullet {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      margin-top: 7px;
      background: radial-gradient(circle at 30% 30%, #ffc36b, #ff9a6b);
    }

    .tldr-text {
      color: rgba(242, 242, 255, 0.96);
    }

    .meta-card {
      border-radius: 18px;
      padding: 10px 11px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: linear-gradient(
        150deg,
        rgba(10, 12, 40, 0.98),
        rgba(3, 6, 23, 0.98)
      );
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .meta-label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 10px;
      color: rgba(204, 204, 255, 0.9);
    }

    .meta-value {
      color: #ffffff;
    }

    .meta-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(7, 9, 32, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.16);
      color: var(--text-muted);
    }

    .meta-note {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Accordion */

    .sections {
      margin-top: 16px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(7, 8, 30, 0.9);
      padding: 10px;
    }

    .sections-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .sections-title {
      font-size: 13px;
      font-weight: 500;
    }

    .sections-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(10, 12, 38, 0.98);
      cursor: pointer;
      color: var(--text-muted);
      transition:
        background var(--transition-fast),
        color var(--transition-fast),
        border-color var(--transition-fast);
    }

    .chip:hover {
      border-color: rgba(255, 255, 255, 0.3);
    }

    .chip.active {
      background: linear-gradient(135deg, #b483ff, #5fd4ff);
      color: #050512;
      border-color: transparent;
    }

    .sections-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    details.section {
      border-radius: 14px;
      padding: 9px 10px;
      background: rgba(5, 7, 28, 0.96);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    details.section[open] {
      background: rgba(8, 11, 40, 0.98);
      border-color: rgba(255, 255, 255, 0.2);
    }

    summary {
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
      font-size: 13px;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    .section-title-main {
      font-weight: 500;
    }

    .section-tag {
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 7px;
      background: rgba(10, 14, 44, 0.96);
      border: 1px solid rgba(255, 255, 255, 0.16);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .section-content {
      margin-top: 8px;
      font-size: 13px;
      color: rgba(235, 235, 255, 0.98);
      line-height: 1.5;
    }

    .section-content p {
      margin-bottom: 6px;
    }

    .section-footer {
      margin-top: 6px;
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .btn-top {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(7, 8, 30, 0.98);
      color: var(--text-main);
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-top .arrow {
      font-size: 12px;
      transform: translateY(0.5px);
    }

    /* Sidebar */

    .card-side {
      position: relative;
      border-radius: 24px;
      padding: 16px 14px 14px;
      background:
        radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.12), transparent 52%),
        radial-gradient(circle at 120% 120%, rgba(95, 212, 255, 0.24), transparent 55%),
        linear-gradient(145deg, rgba(9, 9, 34, 0.98), rgba(3, 6, 23, 0.98));
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
    }

    .side-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .side-title {
      font-size: 13px;
      font-weight: 500;
    }

    .substatus-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(10, 12, 40, 0.96);
      font-size: 11px;
      color: var(--text-muted);
    }

    .substatus-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #5fd4ff, #b483ff);
      box-shadow: 0 0 10px rgba(160, 255, 255, 0.9);
    }

    .side-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .side-body p {
      line-height: 1.5;
    }

    .side-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .btn-wide-primary,
    .btn-wide-ghost {
      border-radius: 16px;
      padding: 8px 10px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: none;
      cursor: pointer;
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        background var(--transition-fast),
        border-color var(--transition-fast),
        color var(--transition-fast);
    }

    .btn-wide-primary {
      background: linear-gradient(135deg, #b483ff, #5fd4ff);
      color: #050512;
      font-weight: 500;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.9);
    }

    .btn-wide-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 1);
    }

    .btn-wide-ghost {
      background: rgba(10, 12, 40, 0.98);
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .btn-wide-ghost:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.9);
      border-color: rgba(255, 255, 255, 0.32);
    }

    .btn-wide-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      text-align: left;
    }

    .btn-wide-main {
      font-size: 13px;
    }

    .btn-wide-sub {
      font-size: 11px;
      color: rgba(7, 8, 30, 0.9);
    }

    .btn-wide-ghost .btn-wide-sub {
      color: var(--text-muted);
    }

    .btn-wide-icon {
      font-size: 15px;
    }

    .side-note {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    footer {
      margin-top: 16px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: left;
    }

    footer a {
      color: var(--accent-2);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="page" id="top">
    <header>
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div class="brand-labels">
          <div class="brand-text-title">The Newsroom</div>
          <div class="brand-text-sub">Daily U.S. politics, debriefed</div>
        </div>
      </div>

      <div class="right-header">
        <div class="pill">
          <span class="pill-dot"></span>
          <span class="pill-label">Daily briefing ¬∑ Auto-updated</span>
        </div>
        <button class="btn-login" type="button">
          <span class="icon">üë§</span>
          <span class="btn-login-label">Login / Sign up</span>
        </button>
      </div>
    </header>

    <main class="layout">
      <section class="card-main">
        <div class="main-header-row">
          <div class="headline">
            <div class="headline-kicker">Today‚Äôs Briefing</div>
            <div class="headline-main">
              Your politics cheat sheet, in one email.
            </div>
            <div class="headline-sub">
              A tight, readable summary of the day‚Äôs U.S. political news ‚Äî
              with context, definitions, and links to dig deeper.
            </div>
          </div>
          <div class="status-chip" id="subStatusChip">
            <span class="status-dot"></span>
            <span id="subStatusText">Checking subscription‚Ä¶</span>
          </div>
        </div>

        <div class="main-body">
          <article class="tldr">
            <div class="tldr-label">What you‚Äôll get</div>
            <ul class="tldr-list">
              <li>
                <span class="tldr-bullet"></span>
                <span class="tldr-text">
                  A single morning email recapping the biggest moves in U.S.
                  politics and policy.
                </span>
              </li>
              <li>
                <span class="tldr-bullet"></span>
                <span class="tldr-text">
                  A neutral, fact-first summary of what happened, why it matters,
                  and what to watch next.
                </span>
              </li>
              <li>
                <span class="tldr-bullet"></span>
                <span class="tldr-text">
                  Jargon explained inline ‚Äî hover terms like ‚Äúcloture‚Äù or ‚Äúmarkup‚Äù
                  to see what they mean.
                </span>
              </li>
            </ul>
          </article>

          <aside class="meta-card">
            <div class="meta-row">
              <div>
                <div class="meta-label">Cadence</div>
                <div class="meta-value">Weekdays ¬∑ Morning delivery</div>
              </div>
              <span class="meta-badge">U.S.-centric ¬∑ Major global stories</span>
            </div>
            <div class="meta-row">
              <div>
                <div class="meta-label">Depth</div>
                <div class="meta-value">TL;DR first, deep dive below</div>
              </div>
            </div>
            <p class="meta-note">
              Built for people who follow politics casually but want to stay
              grounded in real reporting ‚Äî not just the loudest timelines.
            </p>
          </aside>
        </div>

        <section class="sections" aria-label="Briefing sections">
          <div class="sections-header">
            <div class="sections-title">What the email looks like</div>
            <div class="sections-nav">
              <button class="chip active" type="button">Congress</button>
              <button class="chip" type="button">White House</button>
              <button class="chip" type="button">Courts</button>
              <button class="chip" type="button">Campaigns</button>
            </div>
          </div>

          <div class="sections-body">
            <details class="section" open>
              <summary>
                <span class="section-title-main">Congress ¬∑ What passed, what stalled</span>
                <span class="section-tag">Hover-to-define terms</span>
              </summary>
              <div class="section-content">
                <p>
                  Think of this as your running log of what Congress actually
                  did today: which bills moved, which died quietly in committee,
                  and where the leadership fights really are.
                </p>
                <p>
                  Key terms (like
                  <span style="border-bottom: 1px dotted rgba(255,255,255,0.5); cursor: help;"
                        title="A procedure to end debate in the Senate and move to a vote, usually requiring 60 votes.">
                    cloture
                  </span>
                  or
                  <span style="border-bottom: 1px dotted rgba(255,255,255,0.5); cursor: help;"
                        title="The process by which a committee edits and rewrites a bill before it goes to the full chamber.">
                    markup
                  </span>
                  get a short, in-line explanation like this.
                </p>
              </div>
              <div class="section-footer">
                <span>Each section ends with a quick recap + links for deeper reads.</span>
                <button class="btn-top" type="button" onclick="document.getElementById('top').scrollIntoView({ behavior: 'smooth' })">
                  <span class="arrow">‚Üë</span>
                  <span>Back to top</span>
                </button>
              </div>
            </details>

            <details class="section">
              <summary>
                <span class="section-title-main">White House ¬∑ What the administration did</span>
                <span class="section-tag">Policy moves ¬∑ Statements</span>
              </summary>
              <div class="section-content">
                <p>
                  Executive orders, agency rules, press briefings ‚Äî all boiled down
                  into what changed and who it affects.
                </p>
              </div>
              <div class="section-footer">
                <span>Short, readable context so you don‚Äôt have to live on X all day.</span>
                <button class="btn-top" type="button" onclick="document.getElementById('top').scrollIntoView({ behavior: 'smooth' })">
                  <span class="arrow">‚Üë</span>
                  <span>Back to top</span>
                </button>
              </div>
            </details>

            <details class="section">
              <summary>
                <span class="section-title-main">Courts ¬∑ Major rulings & cases</span>
                <span class="section-tag">Supreme Court ¬∑ Key lower courts</span>
              </summary>
              <div class="section-content">
                <p>
                  When a court hands down a ruling that actually changes something,
                  we‚Äôll explain what the decision says ‚Äî and what comes next.
                </p>
              </div>
              <div class="section-footer">
                <span>Focused on impact, not just legalese or hot takes.</span>
                <button class="btn-top" type="button" onclick="document.getElementById('top').scrollIntoView({ behavior: 'smooth' })">
                  <span class="arrow">‚Üë</span>
                  <span>Back to top</span>
                </button>
              </div>
            </details>
          </div>
        </section>
      </section>

      <aside class="card-side">
        <div class="side-header">
          <div class="side-title">Subscription</div>
          <div class="substatus-pill">
            <span class="substatus-dot"></span>
            <span id="subStatusSide">Checking‚Ä¶</span>
          </div>
        </div>

        <div class="side-body">
          <p>
            The beta price is <strong>$1.99 / month</strong>. While we‚Äôre in early
            testing, that gets you:
          </p>
          <ul style="padding-left: 16px; margin-top: 4px; display: flex; flex-direction: column; gap: 4px;">
            <li>‚úÖ Full weekday briefings (not just the preview)</li>
            <li>‚úÖ Archive access while you‚Äôre subscribed</li>
            <li>‚úÖ Ability to suggest topics & recurring explainer terms</li>
          </ul>

          <div class="side-buttons">
            <button class="btn-wide-primary" type="button" id="btnManageBilling">
              <span class="btn-wide-label">
                <span class="btn-wide-main">Manage billing</span>
                <span class="btn-wide-sub" id="btnManageBillingSub">
                  Open Stripe billing portal
                </span>
              </span>
              <span class="btn-wide-icon">‚Üó</span>
            </button>

            <button class="btn-wide-ghost" type="button" id="btnViewSample">
              <span class="btn-wide-label">
                <span class="btn-wide-main">View a sample briefing</span>
                <span class="btn-wide-sub">
                  See the format before subscribing
                </span>
              </span>
              <span class="btn-wide-icon">‚Üí</span>
            </button>
          </div>

          <p class="side-note">
            You can cancel anytime in a couple of clicks via Stripe. No tricks,
            no annual lock-in.
          </p>
        </div>
      </aside>
    </main>

    <footer>
      Built on top of real reporting from outlets across the spectrum.
      We‚Äôll always link out so you can read more from the original sources.
      ¬∑ <a href="https://thenewspaper.site/billing.html">Billing &amp; subscription settings</a>
    </footer>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE_URL = "https://api.thenewspaper.site";

    const COGNITO_DOMAIN    = 'https://thenewsroom-auth-1763795763.auth.us-east-1.amazoncognito.com';
    const COGNITO_CLIENT_ID = '2shion39m0mim70d0etbtp0eh9';
    const COGNITO_REDIRECT  = 'https://thenewspaper.site/callback.html';

    function getTokens() {
      try {
        const raw = localStorage.getItem("newsroom_tokens");
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        console.error("Failed to parse newsroom_tokens:", e);
        return null;
      }
    }

    function clearTokens() {
      localStorage.removeItem("newsroom_tokens");
    }

    // Core API: ALWAYS use the ID TOKEN (what server.ts expects).

    async function callApi(path, options = {}) {
      const tokens = getTokens();
      const idToken = tokens && tokens.id_token;

      if (!idToken) {
        throw new Error("Not logged in");
      }

      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
        Authorization: `Bearer ${idToken}`,   // <-- IMPORTANT
      };

      const res = await fetch(`${API_BASE_URL}${path}`, {
        ...options,
        headers,
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`API ${path} failed: ${res.status} ${text}`);
      }

      return res.json();
    }

    // ===== PKCE / Login flow =====
    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      const hash = await crypto.subtle.digest("SHA-256", data);
      return new Uint8Array(hash);
    }

    function base64UrlEncode(bytes) {
      let binary = "";
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary)
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");
    }

    async function createPkcePair() {
      const verifierBytes = crypto.getRandomValues(new Uint8Array(32));
      const codeVerifier = base64UrlEncode(verifierBytes);
      const hash = await sha256(codeVerifier);
      const codeChallenge = base64UrlEncode(hash);
      return { codeVerifier, codeChallenge };
    }

    function startLogin() {
      createPkcePair().then(({ codeVerifier, codeChallenge }) => {
        sessionStorage.setItem("cognito_code_verifier", codeVerifier);

        const params = new URLSearchParams({
          client_id: COGNITO_CLIENT_ID,
          response_type: "code",
          scope: "openid email profile",
          redirect_uri: COGNITO_REDIRECT,
          code_challenge_method: "S256",
          code_challenge: codeChallenge,
        });

        window.location.href = `${COGNITO_DOMAIN}/oauth2/authorize?${params.toString()}`;
      }).catch((err) => {
        console.error("Failed to start login:", err);
      });
    }

    // ===== Subscription status badge =====
    async function refreshSubscriptionBadge() {
      const sideText   = document.getElementById("subStatusSide");
      const chipText   = document.getElementById("subStatusText");
      const manageSub  = document.getElementById("btnManageBillingSub");

      if (sideText) sideText.textContent = "Checking‚Ä¶";
      if (chipText) chipText.textContent = "Checking subscription‚Ä¶";

      try {
        const data = await callApi("/api/subscription-status", { method: "GET" });

        if (data && data.status === "active") {
          if (sideText) sideText.textContent = "Active ¬∑ Full briefings";
          if (chipText) chipText.textContent = "Subscriber ¬∑ Full access";
          if (manageSub) manageSub.textContent = "Manage subscription in Stripe";
        } else {
          if (sideText) sideText.textContent = "Free preview ¬∑ Upgrade for full email";
          if (chipText) chipText.textContent = "Free preview ¬∑ Upgrade for full brief";
          if (manageSub) manageSub.textContent = "Start subscription for $1.99 / mo";
        }
      } catch (err) {
        console.error("Error refreshing subscription status:", err);
        if (sideText) sideText.textContent = "Error loading status";
        if (chipText) chipText.textContent = "Status unavailable";
        if (manageSub) manageSub.textContent = "Open Stripe billing portal";
      }
    }

    function initAuthUI() {
      const loginBtn  = document.querySelector(".btn-login");
      const labelSpan = document.querySelector(".btn-login-label");
      if (!loginBtn) return;

      const tokens = getTokens();

      if (tokens && tokens.id_token) {
        if (labelSpan) labelSpan.textContent = "Account";
        loginBtn.addEventListener("click", () => {
          window.location.href = "https://thenewspaper.site/billing.html";
        });
        refreshSubscriptionBadge();
      } else {
        loginBtn.addEventListener("click", startLogin);
      }
    }

    function initButtons() {
      const sampleBtn = document.getElementById("btnViewSample");
      const billingBtn = document.getElementById("btnManageBilling");

      if (sampleBtn) {
        sampleBtn.addEventListener("click", () => {
          alert("Sample briefings will be available soon in the beta.");
        });
      }

      if (billingBtn) {
        billingBtn.addEventListener("click", () => {
          window.location.href = "https://thenewspaper.site/billing.html";
        });
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initAuthUI();
      initButtons();
    });
  </script>
</body>
</html>
