<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Newsroom Â· Daily U.S. politics, debriefed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #050516;
      --bg-panel: rgba(14, 16, 40, 0.92);
      --bg-panel-soft: rgba(16, 18, 50, 0.92);
      --border-subtle: rgba(255, 255, 255, 0.08);
      --text-main: #f5f5ff;
      --text-muted: #a3a3c4;
      --accent-1: #b483ff;
      --accent-2: #5fd4ff;
      --danger: #ff6b81;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.6);
      --radius-lg: 24px;
      --radius-md: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Inter", sans-serif;
      min-height: 100vh;
      color: var(--text-main);
      background: radial-gradient(circle at top left, #140b33 0, #050516 40%),
        radial-gradient(circle at bottom right, #02081b 0, #050516 55%);
      display: flex;
      justify-content: center;
      padding: 32px 16px;
    }

    .bg-bubbles {
      position: fixed;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      z-index: -1;
    }

    .bg-bubble {
      position: absolute;
      border-radius: 999px;
      filter: blur(40px);
      opacity: 0.7;
      mix-blend-mode: screen;
      background: radial-gradient(circle at 30% 20%, #ff9cf5 0, transparent 60%);
      animation: float 22s ease-in-out infinite alternate;
    }

    .bg-bubble:nth-child(2) {
      width: 420px;
      height: 420px;
      right: -120px;
      top: 12%;
      background: radial-gradient(circle at 60% 40%, #7dd2ff 0, transparent 60%);
      animation-duration: 28s;
    }

    .bg-bubble:nth-child(3) {
      width: 480px;
      height: 480px;
      left: 10%;
      bottom: -220px;
      background: radial-gradient(circle at 40% 0, #b483ff 0, transparent 60%);
      animation-duration: 32s;
    }

    @keyframes float {
      0% {
        transform: translate3d(0, 10px, 0) scale(1);
      }
      100% {
        transform: translate3d(-10px, -10px, 0) scale(1.05);
      }
    }

    .glare {
      position: absolute;
      inset: -40px;
      background: radial-gradient(
        circle at 0 0,
        rgba(255, 255, 255, 0.1) 0,
        transparent 50%
      );
      mix-blend-mode: soft-light;
      opacity: 0.55;
      pointer-events: none;
      animation: shimmer 14s linear infinite alternate;
    }

    @keyframes shimmer {
      0% {
        transform: translate3d(-10px, 0, 0) scale(1);
      }
      100% {
        transform: translate3d(10px, 0, 0) scale(1.01);
      }
    }

    .page-shell {
      position: relative;
      width: 100%;
      max-width: 1120px;
      border-radius: 32px;
      background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.06), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(22, 181, 255, 0.18), transparent 60%),
        linear-gradient(145deg, rgba(9, 10, 26, 0.96), rgba(3, 6, 25, 0.98));
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.9);
      padding: 20px 22px 24px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 16px;
      background:
        radial-gradient(circle at 0 0, #ffffff, transparent 55%),
        conic-gradient(
          from 140deg,
          #845cff,
          #c184ff,
          #5fd4ff,
          #f26bff,
          #845cff
        );
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.4),
        0 8px 25px rgba(0, 0, 0, 0.85);
    }

    .brand-labels {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-text-title {
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-size: 14px;
      color: var(--text-main);
    }

    .brand-text-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .right-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pill {
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: linear-gradient(
        135deg,
        rgba(180, 131, 255, 0.12),
        rgba(95, 212, 255, 0.12)
      );
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 99px;
      background: radial-gradient(circle at 30% 30%, #5fd4ff, #b483ff);
      box-shadow: 0 0 8px rgba(150, 255, 255, 0.9);
    }

    .btn-login {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.28), transparent 55%),
        linear-gradient(135deg, #24163f, #151830, #151023);
      color: var(--text-main);
      font-size: 13px;
      padding: 6px 16px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: var(--shadow-soft);
      transition: transform 0.16s ease-out, box-shadow 0.16s ease-out,
        border-color 0.16s ease-out, background 0.16s ease-out;
    }

    .btn-login:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.9);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .btn-login .icon {
      font-size: 14px;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.35fr) minmax(0, 1fr);
      gap: 18px;
      align-items: flex-start;
    }

    .panel {
      background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.06),
          rgba(255, 255, 255, 0.01)
        ),
        radial-gradient(circle at 0 0, rgba(240, 165, 255, 0.12), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(95, 212, 255, 0.18), transparent 55%),
        rgba(7, 10, 34, 0.96);
      border-radius: var(--radius-lg);
      padding: 16px 16px 20px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.25),
        rgba(255, 255, 255, 0.02)
      );
      mix-blend-mode: soft-light;
      opacity: 0.35;
      pointer-events: none;
    }

    .panel > * {
      position: relative;
      z-index: 1;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 12px;
    }

    .panel-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .panel-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .panel-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
    }

    .panel-meta-dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #5fd4ff, #b483ff);
    }

    .panel-select {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 9px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(13, 17, 44, 0.9);
      color: var(--text-main);
      outline: none;
    }

    .big-picture-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .big-picture-item {
      padding: 8px 9px;
      border-radius: 12px;
      background: radial-gradient(
          circle at 0 0,
          rgba(183, 140, 255, 0.18),
          transparent 50%
        ),
        linear-gradient(
          135deg,
          rgba(12, 15, 45, 0.98),
          rgba(9, 11, 35, 0.98)
        );
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 13px;
      color: var(--text-main);
      display: flex;
      gap: 8px;
    }

    .big-picture-item::before {
      content: "â€¢";
      color: var(--accent-2);
      margin-right: 4px;
    }

    .placeholder-text {
      font-size: 13px;
      color: var(--text-muted);
      padding: 6px 0 2px;
    }

    .story-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .story-card {
      border-radius: var(--radius-md);
      padding: 10px 11px 10px;
      background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.02)
        ),
        radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.18), transparent 55%),
        rgba(9, 11, 36, 0.96);
      border: 1px solid rgba(255, 255, 255, 0.12);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .story-title-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .story-title {
      font-size: 14px;
      font-weight: 500;
    }

    .story-tag {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: radial-gradient(
        circle at 0 0,
        rgba(95, 212, 255, 0.4),
        transparent 55%
      );
      color: #06151f;
    }

    .story-tldr {
      font-size: 12px;
      color: var(--text-muted);
    }

    .story-summary {
      font-size: 12px;
      color: #dadbf8;
    }

    .story-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .story-meta-sources {
      opacity: 0.9;
    }

    .story-link {
      margin-top: 2px;
      align-self: flex-start;
      font-size: 11px;
      color: #8ee7ff;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .story-link::after {
      content: "â†—";
      font-size: 11px;
    }

    .sub-panel {
      margin-top: 16px;
      border-radius: 18px;
      padding: 12px 13px;
      background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.06),
          rgba(255, 255, 255, 0.02)
        ),
        rgba(7, 9, 31, 0.96);
      border: 1px dashed rgba(255, 255, 255, 0.2);
    }

    .sub-panel-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .prefs-group {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .prefs-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .prefs-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.01)
        ),
        rgba(11, 13, 39, 0.96);
      font-size: 11px;
      cursor: pointer;
      color: var(--text-main);
      transition: border-color 0.16s ease-out, background 0.16s ease-out,
        transform 0.16s ease-out;
    }

    .chip:hover {
      border-color: rgba(255, 255, 255, 0.4);
      transform: translateY(-0.5px);
    }

    .chip input {
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.45);
      background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.4), transparent 55%),
        rgba(10, 11, 37, 0.96);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 3px;
      position: relative;
    }

    .chip input::after {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 3px;
      background: linear-gradient(135deg, #b483ff, #5fd4ff);
      opacity: 0;
      transform: scale(0.7);
      transition: opacity 0.15s ease-out, transform 0.15s ease-out;
    }

    .chip input:checked::after {
      opacity: 1;
      transform: scale(1);
    }

    .chip input:checked + .label {
      color: #eef0ff;
    }

    .chip input:checked ~ .label {
      color: #eef0ff;
    }

    .chip input:checked ~ .chip-bg {
      opacity: 1;
    }

    .chip .label {
      position: relative;
    }

    .identifier-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .id-pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(7, 9, 31, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      cursor: pointer;
    }

    .id-pill input {
      width: 12px;
      height: 12px;
      accent-color: #b483ff;
    }

    .prefs-status {
      margin-top: 6px;
      font-size: 11px;
      color: var(--accent-2);
      opacity: 0;
      transform: translateY(3px);
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
    }

    .prefs-status.visible {
      opacity: 1;
      transform: translateY(0);
    }

    @media (max-width: 860px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }

      .page-shell {
        padding: 18px 16px 22px;
      }
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .right-header {
        width: 100%;
        justify-content: space-between;
      }

      .story-list {
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <div class="bg-bubbles">
    <div class="bg-bubble" style="width:360px;height:360px;left:-140px;top:8%;"></div>
    <div class="bg-bubble"></div>
    <div class="bg-bubble"></div>
  </div>

  <div class="page-shell">
    <div class="glare"></div>

    <header>
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div class="brand-labels">
          <div class="brand-text-title">The Newsroom</div>
          <div class="brand-text-sub">Daily U.S. politics, debriefed</div>
        </div>
      </div>

      <div class="right-header">
        <div class="pill">
          <span class="pill-dot"></span>
          <span class="pill-label">Daily briefing Â· Auto-updated</span>
        </div>
        <button class="btn-login" type="button">
          <span class="icon">ðŸ‘¤</span>
          <span class="btn-login-label">Login / Sign up</span>
        </button>
      </div>
    </header>

    <main>
      <!-- LEFT: Big Picture -->
      <section class="panel" id="big-picture-panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Todayâ€™s Big Picture</div>
            <div class="panel-subtitle">Key threads shaping U.S. politics right now</div>
            <div class="panel-meta">
              <span class="panel-meta-dot"></span>
              <span id="bigPictureDate">No briefing yet</span>
            </div>
          </div>
          <select id="archiveSelect" class="panel-select">
            <option>Loadingâ€¦</option>
          </select>
        </div>

        <ul class="big-picture-list" id="bigPictureList"></ul>
        <div class="placeholder-text" id="bigPictureEmpty">
          No briefing found yet. Once your backend pushes the first daily JSON, this will auto-populate.
        </div>
      </section>

      <!-- RIGHT: Top stories + preferences -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Top stories</div>
            <div class="panel-subtitle">
              Handpicked from NYT, AP, Politico, Guardian, and more
            </div>
          </div>
        </div>

        <div class="story-list" id="storyList"></div>
        <div class="placeholder-text" id="storyEmpty">
          Once todayâ€™s briefing is generated, youâ€™ll see it here. Check back after the EC2 pipeline has run.
        </div>

        <div class="sub-panel">
          <div class="sub-panel-title">Your perspective</div>

          <div class="prefs-group">
            <div class="prefs-label">Topics you care about</div>
            <div class="prefs-chips" id="prefsTopics"></div>
          </div>

          <div class="prefs-group">
            <div class="prefs-label">How political are you?</div>
            <div class="identifier-row">
              <label class="id-pill">
                <input type="checkbox" id="identifierBeginner" />
                <span>New to U.S. politics</span>
              </label>
              <label class="id-pill">
                <input type="checkbox" id="identifierPolicyNerd" />
                <span>Policy & process nerd</span>
              </label>
              <label class="id-pill">
                <input type="checkbox" id="identifierInvestor" />
                <span>Markets & macro watcher</span>
              </label>
            </div>
          </div>

          <div class="prefs-status" id="prefsStatus">Preferences saved. Weâ€™ll quietly bias picks toward this.</div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ---------- CONFIG ----------
    const POSTS_INDEX_URL = "./data/index.json"; // list of posts
    const POST_BY_SLUG_URL = (slug) => `./data/posts/${slug}.json`;

    // Backend API base URL (Stripe + subscription status)
    const API_BASE_URL = "http://localhost:4242"; // change to your EC2 URL in prod

    const DEFAULT_TOPICS = [
      { id: "congress", label: "Congress & legislation" },
      { id: "courts", label: "Supreme Court & courts" },
      { id: "elections", label: "Elections & voting" },
      { id: "foreign_policy", label: "Foreign policy & wars" },
      { id: "economy", label: "Economy & markets" },
      { id: "immigration", label: "Immigration & border" },
      { id: "climate", label: "Climate & energy" },
      { id: "social", label: "Social issues" },
      { id: "state_politics", label: "States & local" }
    ];

    const PREFS_STORAGE_KEY = "newsroom_prefs_v1";

    // ---------- UTIL ----------
    function formatDatePretty(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString(undefined, {
        year: "numeric",
        month: "long",
        day: "numeric"
      });
    }

    function loadPrefs() {
      try {
        const raw = localStorage.getItem(PREFS_STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch (e) {
        console.warn("Failed to parse prefs", e);
        return {};
      }
    }

    function savePrefs(prefs) {
      try {
        localStorage.setItem(PREFS_STORAGE_KEY, JSON.stringify(prefs));
      } catch (e) {
        console.warn("Failed to save prefs", e);
      }
    }

    function showPrefsSaved(el) {
      el.classList.add("visible");
      setTimeout(() => el.classList.remove("visible"), 1800);
    }

    // ---------- PREFS UI ----------
    function initPrefsUI() {
      const prefs = loadPrefs();
      const topics = prefs.topics || {};
      const identifiers = prefs.identifiers || {};
      const prefsTopicsContainer = document.getElementById("prefsTopics");
      const statusEl = document.getElementById("prefsStatus");

      prefsTopicsContainer.innerHTML = "";

      DEFAULT_TOPICS.forEach((topic) => {
        const chip = document.createElement("label");
        chip.className = "chip";

        const input = document.createElement("input");
        input.type = "checkbox";
        input.checked = !!topics[topic.id];

        const labelSpan = document.createElement("span");
        labelSpan.className = "label";
        labelSpan.textContent = topic.label;

        input.addEventListener("change", () => {
          const prefs = loadPrefs();
          prefs.topics = prefs.topics || {};
          prefs.topics[topic.id] = input.checked;
          savePrefs(prefs);
          showPrefsSaved(statusEl);
        });

        chip.appendChild(input);
        chip.appendChild(labelSpan);
        prefsTopicsContainer.appendChild(chip);
      });

      // identifiers
      const identifierBeginner = document.getElementById("identifierBeginner");
      const identifierPolicyNerd = document.getElementById("identifierPolicyNerd");
      const identifierInvestor = document.getElementById("identifierInvestor");

      identifierBeginner.checked = !!identifiers.beginner;
      identifierPolicyNerd.checked = !!identifiers.policyNerd;
      identifierInvestor.checked = !!identifiers.investor;

      const handleIdentifierChange = () => {
        const newPrefs = loadPrefs();
        newPrefs.identifiers = {
          beginner: identifierBeginner.checked,
          policyNerd: identifierPolicyNerd.checked,
          investor: identifierInvestor.checked
        };
        savePrefs(newPrefs);
        showPrefsSaved(statusEl);
      };

      identifierBeginner.addEventListener("change", handleIdentifierChange);
      identifierPolicyNerd.addEventListener("change", handleIdentifierChange);
      identifierInvestor.addEventListener("change", handleIdentifierChange);
    }

    // ---------- DATA LOADING ----------
    async function loadPostsIndex() {
      try {
        const res = await fetch(POSTS_INDEX_URL, { cache: "no-cache" });
        if (!res.ok) throw new Error("Index HTTP " + res.status);
        return res.json();
      } catch (e) {
        console.error("Failed to load posts index", e);
        return [];
      }
    }

    async function loadPostBySlug(slug) {
      try {
        const res = await fetch(POST_BY_SLUG_URL(slug), { cache: "no-cache" });
        if (!res.ok) throw new Error("Post HTTP " + res.status);
        return res.json();
      } catch (e) {
        console.error("Failed to load post", e);
        return null;
      }
    }

    // ---------- RENDERING ----------
    function renderBigPicture(post) {
      const listEl = document.getElementById("bigPictureList");
      const emptyEl = document.getElementById("bigPictureEmpty");
      const dateEl = document.getElementById("bigPictureDate");

      listEl.innerHTML = "";

      if (!post || !post.bigPicture || post.bigPicture.length === 0) {
        emptyEl.style.display = "block";
        dateEl.textContent = "No briefing yet";
        return;
      }
      emptyEl.style.display = "none";

      post.bigPicture.forEach((line) => {
        const li = document.createElement("li");
        li.className = "big-picture-item";
        li.textContent = line;
        listEl.appendChild(li);
      });

      dateEl.textContent = `Updated ${formatDatePretty(post.date)}`;
    }

    function renderStories(post) {
      const listEl = document.getElementById("storyList");
      const emptyEl = document.getElementById("storyEmpty");
      listEl.innerHTML = "";

      if (!post || !post.stories || post.stories.length === 0) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      post.stories.forEach((story) => {
        const card = document.createElement("article");
        card.className = "story-card";

        const main = document.createElement("div");

        const titleRow = document.createElement("div");
        titleRow.className = "story-title-row";

        const title = document.createElement("div");
        title.className = "story-title";
        title.textContent = story.title || "Untitled story";

        const tag = document.createElement("span");
        tag.className = "story-tag";
        tag.textContent = (story.category || "Politics").toUpperCase();

        titleRow.appendChild(title);
        titleRow.appendChild(tag);

        const tldr = document.createElement("div");
        tldr.className = "story-tldr";
        tldr.textContent = story.tldr || story.summary || "";

        const summary = document.createElement("div");
        summary.className = "story-summary";
        summary.textContent = story.body || story.summaryLong || "";

        const meta = document.createElement("div");
        meta.className = "story-meta";

        const sources = document.createElement("span");
        sources.className = "story-meta-sources";
        sources.textContent = story.sources && story.sources.length
          ? "Sources: " + story.sources.join(", ")
          : story.source || "Multiple sources";

        const time = document.createElement("span");
        time.textContent = formatDatePretty(story.date) || "Today";

        meta.appendChild(sources);
        meta.appendChild(time);

        main.appendChild(titleRow);
        main.appendChild(tldr);
        main.appendChild(summary);
        main.appendChild(meta);

        const link =
          story.sourceUrl || story.url
            ? document.createElement("a")
            : document.createElement("span");

        if (link.tagName.toLowerCase() === "a") {
          link.className = "story-link";
          link.href = story.sourceUrl || story.url;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = "Open story";
        } else {
          link.className = "story-link";
          link.textContent = "No source link";
          link.style.opacity = "0.5";
        }

        card.appendChild(main);
        card.appendChild(link);
        listEl.appendChild(card);
      });
    }

    async function hydratePage() {
      initPrefsUI();

      const archiveSelect = document.getElementById("archiveSelect");

      const posts = await loadPostsIndex();
      archiveSelect.innerHTML = "";

      if (!posts.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No briefings yet";
        archiveSelect.appendChild(opt);
        renderBigPicture(null);
        renderStories(null);
        return;
      }

      posts.forEach((p, idx) => {
        const opt = document.createElement("option");
        opt.value = p.slug;
        opt.textContent =
          idx === 0
            ? `Today Â· ${formatDatePretty(p.date)}`
            : formatDatePretty(p.date);
        archiveSelect.appendChild(opt);
      });

      const firstSlug = posts[0].slug;
      const firstPost = await loadPostBySlug(firstSlug);
      renderBigPicture(firstPost);
      renderStories(firstPost);

      archiveSelect.addEventListener("change", async () => {
        const slug = archiveSelect.value;
        if (!slug) return;
        const post = await loadPostBySlug(slug);
        renderBigPicture(post);
        renderStories(post);
      });
    }

    // ---------- AUTH (Cognito login + Stripe API helper) ----------
    const COGNITO_DOMAIN    = 'https://thenewsroom-auth-1763795763.auth.us-east-1.amazoncognito.com';
    const COGNITO_CLIENT_ID = '2shion39m0mim70d0etbtp0eh9';
    const COGNITO_REDIRECT  = 'https://daltonthedeveloper.github.io/thenewspaper-website/callback.html';

    function getTokens() {
      try {
        const raw = localStorage.getItem('newsroom_tokens');
        return raw ? JSON.parse(raw) : null;
      } catch {
        return null;
      }
    }

    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      const hash = await crypto.subtle.digest("SHA-256", data);
      return new Uint8Array(hash);
    }

    function base64UrlEncode(bytes) {
      let binary = "";
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    async function createPkcePair() {
      const codeVerifier = base64UrlEncode(crypto.getRandomValues(new Uint8Array(32)));
      const hashed = await sha256(codeVerifier);
      const codeChallenge = base64UrlEncode(hashed);
      return { codeVerifier, codeChallenge };
    }

    function startLogin() {
      createPkcePair().then(({ codeVerifier, codeChallenge }) => {
        sessionStorage.setItem("cognito_code_verifier", codeVerifier);

        const params = new URLSearchParams({
          client_id: COGNITO_CLIENT_ID,
          response_type: "code",
          scope: "openid email profile",
          redirect_uri: COGNITO_REDIRECT,
          code_challenge_method: "S256",
          code_challenge: codeChallenge,
        });

        window.location.href = `${COGNITO_DOMAIN}/oauth2/authorize?${params.toString()}`;
      }).catch((err) => {
        console.error("Failed to start login", err);
      });
    }

    async function callApi(path, options = {}) {
      const tokens = getTokens();
      if (!tokens || !tokens.id_token) {
        throw new Error("Not logged in");
      }
      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
        Authorization: `Bearer ${tokens.id_token}`,
      };

      const res = await fetch(`${API_BASE_URL}${path}`, {
        ...options,
        headers,
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`API ${path} failed: ${res.status} ${text}`);
      }

      return res.json();
    }

    async function refreshSubscriptionBadge() {
      const pillLabel = document.querySelector(".pill-label");
      if (!pillLabel) return;

      const tokens = getTokens();
      if (!tokens || !tokens.id_token) {
        pillLabel.textContent = "Daily briefing Â· Auto-updated";
        return;
      }

      try {
        const status = await callApi("/api/subscription-status", { method: "GET" });
        if (status.active) {
          pillLabel.textContent = "Subscriber Â· Daily briefing";
        } else {
          pillLabel.textContent = "Daily briefing Â· Free preview";
        }
      } catch (err) {
        console.warn("Subscription status check failed:", err);
      }
    }

    function initAuthUI() {
      const loginBtn = document.querySelector(".btn-login");
      const labelSpan = document.querySelector(".btn-login-label");
      if (!loginBtn) return;

      const tokens = getTokens();

      if (tokens && tokens.id_token) {
        if (labelSpan) labelSpan.textContent = "Account";
        loginBtn.addEventListener("click", () => {
          window.location.href = "https://thenewspaper.site/billing.html";
        });
        refreshSubscriptionBadge();
      } else {
        loginBtn.addEventListener("click", startLogin);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      hydratePage().catch((e) => console.error(e));
      initAuthUI();
    });

  </script>
</body>
</html>
