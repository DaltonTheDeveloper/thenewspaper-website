<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Billing – The Newsroom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #050512;
      --bg-glass: rgba(19, 20, 48, 0.75);
      --accent-purple: #b483ff;
      --accent-pink: #ff7edb;
      --accent-blue: #5fd4ff;
      --text-main: #f5f5ff;
      --text-muted: #a0a0c5;
      --border-subtle: rgba(255, 255, 255, 0.15);
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.6);
      --radius-xl: 24px;
      --transition-fast: 0.18s ease-out;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Inter",sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #20143a 0, #050512 35%) fixed;
      background-color: var(--bg-main);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 0 0, rgba(255,255,255,0.06), transparent 55%),
                  radial-gradient(circle at 100% 100%, rgba(255,255,255,0.04), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.55;
      pointer-events: none;
      animation: shimmer 14s linear infinite alternate;
    }
    @keyframes shimmer {
      0% { transform: translate3d(-10px,0,0) scale(1); }
      100% { transform: translate3d(10px,0,0) scale(1.01); }
    }
    .page-shell {
      position: relative;
      width: 100%;
      max-width: 720px;
      padding: 20px 16px 32px;
      z-index: 1;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 18px;
      background: radial-gradient(circle at 30% 20%, #ffffff, #f3d5ff 30%, #7b5bff 65%, #1c1034 100%);
      box-shadow: 0 10px 25px rgba(0,0,0,0.75),
                  0 0 0 1px rgba(255,255,255,0.3);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    .brand-logo::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg,
        rgba(255,255,255,0.3),
        transparent 35%,
        transparent 65%,
        rgba(255,255,255,0.15));
      mix-blend-mode: soft-light;
      opacity: 0.8;
    }
    .brand-labels { display:flex; flex-direction:column; gap:2px; }
    .brand-text-title {
      font-weight: 600;
      letter-spacing: .05em;
      text-transform: uppercase;
      font-size: 14px;
    }
    .brand-text-sub { font-size: 12px; color: var(--text-muted); }

    .pill {
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.15);
      background: linear-gradient(135deg,
        rgba(180,131,255,0.12),
        rgba(95,212,255,0.12));
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .pill-dot {
      width: 6px; height: 6px;
      border-radius: 999px;
      background: radial-gradient(circle, var(--accent-purple), var(--accent-blue));
      box-shadow: 0 0 8px rgba(191,128,255,0.9);
    }

    .panel {
      margin-top: 10px;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.08), transparent 55%),
                  var(--bg-glass);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }
    .panel::before {
      content: "";
      position: absolute;
      inset: -140%;
      background: conic-gradient(
        from 180deg,
        rgba(191,128,255,0.08),
        transparent,
        rgba(95,212,255,0.06),
        transparent,
        rgba(255,126,219,0.07)
      );
      opacity: 0.7;
      mix-blend-mode: soft-light;
      animation: panelGlow 16s linear infinite;
      pointer-events: none;
    }
    @keyframes panelGlow {
      from { transform: translate3d(-10px,0,0) rotate(0deg); }
      to   { transform: translate3d(10px,0,0) rotate(2deg); }
    }
    .panel-content { position:relative; z-index:1; }

    .billing-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .billing-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .status-pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:4px 10px;
      font-size:11px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(5,5,24,0.9);
      margin-bottom:10px;
    }
    .status-dot {
      width:7px;height:7px;border-radius:999px;
      background: radial-gradient(circle, var(--accent-blue), var(--accent-purple));
      box-shadow:0 0 10px rgba(95,212,255,0.9);
    }

    .billing-actions {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:14px;
    }
    .btn-primary, .btn-secondary {
      border-radius:999px;
      padding:9px 16px;
      font-size:13px;
      border:1px solid rgba(255,255,255,0.25);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:transform var(--transition-fast),
                 box-shadow var(--transition-fast),
                 background var(--transition-fast),
                 border-color var(--transition-fast),
                 opacity var(--transition-fast);
    }
    .btn-primary {
      background: radial-gradient(circle at 0 0, rgba(255,255,255,0.28), transparent 55%),
                  linear-gradient(135deg, #3b163f, #24163f, #151830);
      color: var(--text-main);
      box-shadow: var(--shadow-soft);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 22px 55px rgba(0,0,0,0.9);
      border-color: rgba(255,255,255,0.4);
    }
    .btn-secondary {
      background: rgba(5,5,24,0.9);
      color: var(--text-muted);
    }
    .btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.8);
    }
    .btn-disabled { opacity:0.6; cursor:default; }

    .billing-note {
      font-size:11px;
      color:var(--text-muted);
      margin-top:8px;
    }

    .alert {
      margin-top:8px;
      font-size:11px;
      color:var(--accent-blue);
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <header>
      <div class="brand">
        <div class="brand-logo" id="logo"></div>
        <div class="brand-labels">
          <div class="brand-text-title">The Newsroom</div>
          <div class="brand-text-sub">Subscription & billing</div>
        </div>
      </div>
      <div class="pill">
        <span class="pill-dot"></span>
        Billing · Secure
      </div>
    </header>

    <section class="panel">
      <div class="panel-content">
        <div class="billing-title">Your subscription</div>
        <div class="billing-subtitle">
          Manage your $1.99/mo plan for The Newsroom daily briefing.
        </div>

        <div class="status-pill" id="statusPill">
          <span class="status-dot"></span>
          <span id="statusText">Checking status…</span>
        </div>

        <div class="billing-actions">
          <button class="btn-primary" id="subscribeBtn">Subscribe · $1.99/mo</button>
          <button class="btn-secondary" id="manageBtn">Manage billing</button>
        </div>

        <div class="billing-note">
          Payments are handled by Stripe. You can cancel any time from the billing portal.
        </div>

        <div class="alert" id="alertBox"></div>
      </div>
    </section>
  </div>

  <script>
    // --- Same Cognito config you use in index.html ---
    const COGNITO_DOMAIN    = 'https://thenewsroom-auth-1763795763.auth.us-east-1.amazoncognito.com';
    const COGNITO_CLIENT_ID = '2shion39m0mim70d0etbtp0eh9';
    const REDIRECT_URI      = 'https://daltonthedeveloper.github.io/thenewspaper-website/callback.html';

    // Backend API base URL
    const API_BASE_URL = "https://api.thenewspaper.site"; // change to your EC2 URL

    function getTokens() {
      try {
        const raw = localStorage.getItem('newsroom_tokens');
        return raw ? JSON.parse(raw) : null;
      } catch {
        return null;
      }
    }

    async function callApi(path, options = {}) {
      const tokens = getTokens();
      if (!tokens?.id_token) {
        throw new Error("Not logged in");
      }
      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
        Authorization: `Bearer ${tokens.id_token}`,
      };
      const res = await fetch(`${API_BASE_URL}${path}`, {
        ...options,
        headers,
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`API ${path} failed: ${res.status} ${text}`);
      }
      return res.json();
    }

    function ensureLoggedInOrRedirect() {
      const tokens = getTokens();
      if (!tokens?.id_token) {
        // Force them to login before billing
        window.location.href = "https://thenewspaper.site/";
      }
    }

    async function refreshStatus() {
      const statusText = document.getElementById("statusText");
      const subscribeBtn = document.getElementById("subscribeBtn");
      const manageBtn = document.getElementById("manageBtn");

      try {
        const status = await callApi("/api/subscription-status", { method: "GET" });

        if (status.active) {
          statusText.textContent = `Active · ${new Date(status.current_period_end * 1000).toLocaleDateString()}`;
          subscribeBtn.textContent = "Upgrade / change plan";
        } else {
          statusText.textContent = "No active subscription";
          subscribeBtn.textContent = "Subscribe · $1.99/mo";
        }
      } catch (err) {
        console.warn(err);
        statusText.textContent = "Could not load status";
      }
    }

    async function handleSubscribe() {
      const alertBox = document.getElementById("alertBox");
      alertBox.textContent = "";

      try {
        const data = await callApi("/api/create-checkout-session", {
          method: "POST",
          body: JSON.stringify({}),
        });
        if (!data.url) throw new Error("No checkout URL");
        window.location.href = data.url;
      } catch (err) {
        console.error(err);
        alertBox.textContent = "Could not start checkout. Try again in a moment.";
      }
    }

    async function handleManage() {
      const alertBox = document.getElementById("alertBox");
      alertBox.textContent = "";

      try {
        const data = await callApi("/api/create-portal-session", {
          method: "POST",
          body: JSON.stringify({}),
        });
        if (!data.url) throw new Error("No portal URL");
        window.location.href = data.url;
      } catch (err) {
        console.error(err);
        alertBox.textContent = "Could not open billing portal.";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("logo").addEventListener("click", () => {
        window.location.href = "https://thenewspaper.site/";
      });

      ensureLoggedInOrRedirect();
      refreshStatus();

      document.getElementById("subscribeBtn").addEventListener("click", handleSubscribe);
      document.getElementById("manageBtn").addEventListener("click", handleManage);
    });
  </script>
</body>
</html>
