<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Subscription</title>
<link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="card">
  <h2>Subscription</h2>
  <p>Unlock the full daily briefing for $1.99 / month.</p>

  <div class="row space">
    <span>Status</span>
    <span id="user-email"></span>
  </div>

  <div class="status-box">
    <span id="subscription-status">Loading…</span>
    <span class="badge" id="status-badge">Loading…</span>
  </div>

  <button id="subscribe-btn" class="primary-button">
    Subscribe · $1.99 / mo
  </button>

  <button id="manage-btn" class="secondary-button">
    Manage billing
  </button>

  <button id="refresh-btn" class="secondary-button">
    Refresh status
  </button>

  <p class="small">
    You’ll be redirected to Stripe’s secure checkout page. You can cancel anytime via Stripe.
  </p>

  <pre id="error-text" class="error"></pre>

  <a href="index.html" class="back-link">← Back to The Newsroom</a>
</div>

<script>
  const API_BASE_URL = "https://api.thenewspaper.site";

  /* -------------------------------
      SESSION + TOKEN HELPERS
  --------------------------------*/
  function getSession() {
    const raw = localStorage.getItem("newsroom-session");
    if (!raw) return null;
    try { return JSON.parse(raw); }
    catch { return null; }
  }

  function getIdToken() {
    const session = getSession();
    return session?.id_token || null;
  }

  function getUserEmail() {
    const session = getSession();
    return session?.email || "";
  }

  /* -------------------------------
        GENERIC API WRAPPER
  --------------------------------*/
  async function fetchJSON(path, options = {}) {
    const token = getIdToken();

    if (!token) {
      const err = new Error("No login session");
      err.name = "NoSessionError";
      throw err;
    }

    const res = await fetch(`${API_BASE_URL}${path}`, {
      ...options,
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
        ...(options.headers || {}),
      },
    });

    if (res.status === 401) {
      const err = new Error("Session expired");
      err.name = "SessionExpiredError";
      throw err;
    }

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`API ${path} failed: ${res.status} ${text}`);
    }

    return res.json();
  }

  /* -------------------------------
        LOAD SUBSCRIPTION STATUS
  --------------------------------*/
  async function loadSubscriptionStatus() {
    const statusEl = document.getElementById("subscription-status");
    const statusBadge = document.getElementById("status-badge");
    const errorEl = document.getElementById("error-text");

    statusEl.textContent = "Loading…";
    statusBadge.textContent = "Loading…";
    errorEl.textContent = "";

    try {
      const data = await fetchJSON("/api/subscription-status");

      if (data.status === "active") {
        statusEl.textContent = "Active";
        statusBadge.textContent = "Active";
      } else {
        statusEl.textContent = "No active subscription";
        statusBadge.textContent = "None";
      }

    } catch (err) {
      console.error(err);

      if (err.name === "NoSessionError" || err.name === "SessionExpiredError") {
        statusEl.textContent = "Not logged in";
        statusBadge.textContent = "Login required";
        errorEl.textContent = "Please return to the homepage and log in again.";
        return;
      }

      statusEl.textContent = "Could not load subscription status.";
      statusBadge.textContent = "Error";
      errorEl.textContent = String(err);
    }
  }

  /* -------------------------------
        CHECKOUT BUTTON
  --------------------------------*/
  async function startCheckout() {
    const errorEl = document.getElementById("error-text");
    errorEl.textContent = "";

    try {
      const data = await fetchJSON("/api/create-checkout-session", {
        method: "POST",
        body: JSON.stringify({}),
      });

      if (data.url) {
        window.location.href = data.url;
      }

    } catch (err) {
      console.error(err);

      if (err.name === "NoSessionError" || err.name === "SessionExpiredError") {
        errorEl.textContent = "Your session expired. Please log in again.";
        return;
      }

      errorEl.textContent = "Could not start checkout: " + err;
    }
  }

  /* -------------------------------
        BILLING PORTAL
  --------------------------------*/
  async function openBillingPortal() {
    const errorEl = document.getElementById("error-text");
    errorEl.textContent = "";

    try {
      const data = await fetchJSON("/api/create-portal-session", {
        method: "POST",
        body: JSON.stringify({}),
      });

      if (data.url) window.location.href = data.url;

    } catch (err) {
      console.error(err);

      if (err.name === "NoSessionError" || err.name === "SessionExpiredError") {
        errorEl.textContent = "Session expired. Please log in again.";
        return;
      }

      errorEl.textContent = "Could not open billing portal: " + err;
    }
  }

  /* -------------------------------
        INIT PAGE
  --------------------------------*/
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("user-email").textContent = getUserEmail() || "(not logged in)";

    loadSubscriptionStatus();

    document.getElementById("subscribe-btn").addEventListener("click", startCheckout);
    document.getElementById("manage-btn").addEventListener("click", openBillingPortal);
    document.getElementById("refresh-btn").addEventListener("click", loadSubscriptionStatus);
  });
</script>

</body>
</html>
